<?php
// Enable error reporting for debugging
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Start output buffering
ob_start();

require_once 'config.php';
require_once 'functions.php';

$message = '';

// Log incoming requests for debugging
error_log("Request URI: " . $_SERVER['REQUEST_URI']);
error_log("Query String: " . $_SERVER['QUERY_STRING']);
error_log("GET Parameters: " . print_r($_GET, true));

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    error_log("Starting POST request processing");

    $key = isset($_POST['key']) ? sanitize($_POST['key']) : (isset($_POST['original_key']) ? sanitize($_POST['original_key']) : '');
    $title = isset($_POST['title']) ? sanitize($_POST['title']) : '';
    $description = isset($_POST['description']) ? sanitize($_POST['description']) : '';
    $editing_id = isset($_POST['editing_id']) ? (int)$_POST['editing_id'] : null;

    error_log("POST Data: " . print_r($_POST, true));
    error_log("Files: " . print_r($_FILES, true));
    error_log("Editing ID: " . $editing_id);

    // Validate inputs
    if ($editing_id) {
        // For editing, key is optional (use original_key), but title and description are required
        if (empty($title) || empty($description)) {
            $message = 'Please fill in all required fields (Title, Description).';
            error_log("Validation failed: Missing required fields for editing");
        }
    } else {
        // For new activities, all fields including key are required
        if (empty($key) || empty($title) || empty($description)) {
            $message = 'Please fill in all required fields (Key, Title, Description).';
            error_log("Validation failed: Missing required fields for new activity");
        }
    }

    if (!$message) {
        // Handle activity image
        $image_path = '';
        if (isset($_FILES['image']) && $_FILES['image']['error'] === UPLOAD_ERR_OK) {
            error_log("Uploading new activity image");
            $upload = uploadFile($_FILES['image'], $editing_id ?? uniqid(), 'activity');
            if (isset($upload['error'])) {
                $message = 'Activity image upload failed: ' . $upload['error'];
                error_log("Activity image upload failed: " . $upload['error']);
            } else {
                $image_path = $upload['path'];
                error_log("Activity image uploaded: " . $image_path);
            }
        } elseif ($editing_id) {
            error_log("Reusing existing activity image for ID: " . $editing_id);
            $stmt = $pdo->prepare("SELECT image FROM activities WHERE id = ?");
            $stmt->execute([$editing_id]);
            $image_path = $stmt->fetchColumn();
            if (!$image_path) {
                $message = 'Existing image not found for this activity in the database.';
                error_log("Existing activity image not found in database");
            } elseif (!file_exists($image_path)) {
                $message = 'The image file for this activity no longer exists on the server.';
                error_log("Activity image file does not exist: " . $image_path);
            }
        } else {
            $message = 'Please upload a JPG image for the activity.';
            error_log("No activity image provided for new activity");
        }

        if (!$message) {
            try {
                // Save or update activity
                if ($editing_id) {
                    error_log("Updating activity with ID: " . $editing_id);
                    $stmt = $pdo->prepare("UPDATE activities SET `key` = ?, title = ?, image = ?, description = ? WHERE id = ?");
                    $stmt->execute([$key, $title, $image_path, $description, $editing_id]);
                    error_log("Activity updated successfully");

                    error_log("Deleting existing related places for activity ID: " . $editing_id);
                    $pdo->prepare("DELETE FROM related_places WHERE activity_id = ?")->execute([$editing_id]);
                    error_log("Existing related places deleted");
                } else {
                    error_log("Inserting new activity");
                    $stmt = $pdo->prepare("INSERT INTO activities (`key`, title, image, description) VALUES (?, ?, ?, ?)");
                    $stmt->execute([$key, $title, $image_path, $description]);
                    $editing_id = $pdo->lastInsertId();
                    error_log("New activity inserted with ID: " . $editing_id);
                }

                // Handle related places
                if (isset($_POST['related-title']) && !empty($_POST['related-title'])) {
                    error_log("Processing related places");
                    foreach ($_POST['related-title'] as $index => $related_title) {
                        $related_title = sanitize($related_title);
                        $related_description = sanitize($_POST['related-description'][$index] ?? '');
                        $related_map = sanitize($_POST['related-map'][$index] ?? '');
                        $related_image_path = '';

                        error_log("Related Place [$index]: Title=$related_title, Description=$related_description, Map=$related_map");

                        // Check if a new image is uploaded
                        if (isset($_FILES['related-image']['name'][$index]) && $_FILES['related-image']['error'][$index] === UPLOAD_ERR_OK) {
                            error_log("Uploading image for related place #$index");
                            $file = [
                                'name' => $_FILES['related-image']['name'][$index],
                                'type' => $_FILES['related-image']['type'][$index],
                                'tmp_name' => $_FILES['related-image']['tmp_name'][$index],
                                'error' => $_FILES['related-image']['error'][$index],
                                'size' => $_FILES['related-image']['size'][$index]
                            ];
                            $upload = uploadFile($file, $editing_id . '_related_' . $index, 'related');
                            if (isset($upload['error'])) {
                                $message = "Related place image upload failed for place #$index: " . $upload['error'];
                                error_log("Related place image upload failed: " . $upload['error']);
                                break;
                            } else {
                                $related_image_path = $upload['path'];
                                error_log("Related place image uploaded: " . $related_image_path);
                            }
                        } elseif (isset($_POST['existing-related-image'][$index])) {
                            $related_image_path = sanitize($_POST['existing-related-image'][$index]);
                            error_log("Using existing image for related place #$index: " . $related_image_path);
                        } else {
                            $message = "Please upload a JPG image for related place #$index.";
                            error_log("Validation failed: Missing image for related place #$index");
                            break;
                        }

                        // Validate related place fields
                        if (empty($related_title)) {
                            $message = "Please provide a title for related place #$index.";
                            error_log("Validation failed: Missing title for related place #$index");
                            break;
                        }
                        if (empty($related_description)) {
                            $message = "Please provide a description for related place #$index.";
                            error_log("Validation failed: Missing description for related place #$index");
                            break;
                        }

                        // Insert related place with map link
                        error_log("Inserting related place #$index");
                        $stmt = $pdo->prepare("INSERT INTO related_places (activity_id, title, image, description, map) VALUES (?, ?, ?, ?, ?)");
                        $stmt->execute([$editing_id, $related_title, $related_image_path, $related_description, $related_map]);
                        error_log("Related place #$index inserted successfully");
                    }
                } else {
                    error_log("No related places provided");
                }

                if (!$message) {
                    $message = 'Activity saved successfully!';
                    error_log("Activity saved successfully");
                    ob_end_clean();
                    header("Location: activityadmin.php");
                    exit;
                }
            } catch (PDOException $e) {
                $message = 'Database error: ' . $e->getMessage();
                error_log("Database error: " . $e->getMessage());
            }
        }
    }
}

// Handle deletion
if (isset($_GET['delete'])) {
    error_log("Processing DELETE for ID: " . $_GET['delete']);
    try {
        $id = (int)$_GET['delete'];
        $stmt = $pdo->prepare("SELECT image FROM activities WHERE id = ?");
        $stmt->execute([$id]);
        $activity = $stmt->fetch(PDO::FETCH_ASSOC);
        if (!$activity) {
            $message = 'Activity not found.';
            error_log("Activity not found for deletion");
        } else {
            $image = $activity['image'];
            if ($image && file_exists($image)) {
                unlink($image);
                error_log("Deleted activity image: " . $image);
            }
            $stmt = $pdo->prepare("SELECT image FROM related_places WHERE activity_id = ?");
            $stmt->execute([$id]);
            foreach ($stmt->fetchAll(PDO::FETCH_COLUMN) as $related_image) {
                if ($related_image && file_exists($related_image)) {
                    unlink($related_image);
                    error_log("Deleted related image: " . $related_image);
                }
            }
            $pdo->prepare("DELETE FROM activities WHERE id = ?")->execute([$id]);
            $message = 'Activity deleted successfully!';
            error_log("Activity deleted successfully");
            ob_end_clean();
            header("Location: activityadmin.php");
            exit;
        }
    } catch (PDOException $e) {
        $message = 'Deletion failed: ' . $e->getMessage();
        error_log("Deletion failed: " . $e->getMessage());
    }
}

// Fetch all activities
try {
    $stmt = $pdo->query("SELECT * FROM activities");
    $activities = $stmt->fetchAll(PDO::FETCH_ASSOC);
} catch (PDOException $e) {
    $message = 'Failed to fetch activities: ' . $e->getMessage();
    error_log("Failed to fetch activities: " . $e->getMessage());
    $activities = [];
}

// Fetch editing data
$editing = null;
if (isset($_GET['edit'])) {
    error_log("Processing EDIT for ID: " . $_GET['edit']);
    try {
        $id = (int)$_GET['edit'];
        $stmt = $pdo->prepare("SELECT * FROM activities WHERE id = ?");
        $stmt->execute([$id]);
        $editing = $stmt->fetch(PDO::FETCH_ASSOC);
        if ($editing) {
            $stmt = $pdo->prepare("SELECT * FROM related_places WHERE activity_id = ?");
            $stmt->execute([$id]);
            $editing['related'] = $stmt->fetchAll(PDO::FETCH_ASSOC);
            error_log("Fetched editing data for ID: " . $id);
        } else {
            $message = 'Activity not found for editing.';
            error_log("Activity not found for editing: ID " . $id);
        }
    } catch (PDOException $e) {
        $message = 'Failed to fetch activity for editing: ' . $e->getMessage();
        error_log("Failed to fetch activity for editing: " . $e->getMessage());
    }
}
?>
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - TravelGuide</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #e5f4fd;
      color: #1a1a1a;
    }

    nav {
      background: rgba(31, 41, 55, 0.8);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .logo {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 2rem;
      color: #fff;
    }

    .logo span {
      color: #f97316;
      padding-left: 0.5rem;
    }

    .nav-links {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-size: 1.2rem;
      font-weight: 600;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      transition: background 0.3s, transform 0.2s, text-decoration 0.2s;
    }

    .always-underline {
      text-decoration: underline !important;
    }

    .nav-links a:hover {
      background-color: #f97316;
      transform: translateY(-2px);
      text-decoration: underline;
    }

    .dropdown {
      position: relative;
    }

    .dropdown-content {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      background-color: #fff;
      min-width: 180px;
      border-radius: 5px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      z-index: 1000;
      transition: opacity 0.2s ease-in-out, transform 0.2s ease-in-out;
      transform: translateY(5px);
      opacity: 0;
    }

    .dropdown-content a {
      color: #1a1a1a;
      padding: 1rem 1.5rem;
      display: block;
      font-size: 0.95rem;
      transition: background 0.2s;
    }

    .dropdown-content a:hover {
      background-color: #e5f4fd;
    }

    .dropdown:hover .dropdown-content {
      display: block;
      opacity: 1;
      transform: translateY(0);
    }

    .login-btn {
      position: relative;
    }

    .login-btn button {
      background: #f97316;
      border: none;
      padding: 0.5rem 1.5rem;
      border-radius: 20px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: background 0.3s, transform 0.2s;
    }

    .login-btn button:hover {
      background: #e55e00;
      transform: translateY(-2px);
    }

    .container {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 2rem;
    }

    h1 {
      text-align: center;
      font-size: 2.5rem;
      color: #0077b6;
      margin-bottom: 2rem;
    }

    .message {
      text-align: center;
      padding: 1rem;
      margin-bottom: 1rem;
      border-radius: 5px;
      color: white;
    }

    .message.success {
      background: #8BC34A;
    }

    .message.error {
      background: #d32f2f;
    }

    .admin-form {
      background: #fff;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin-bottom: 2rem;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-group label {
      display: block;
      font-size: 1rem;
      font-weight: 600;
      color: #0077b6;
      margin-bottom: 0.5rem;
    }

    .form-group input,
    .form-group textarea {
      width: 100%;
      padding: 0.8rem;
      border: 1px solid #ccc;
      border-radius: 5px;
      font-size: 0.9rem;
    }

    .form-group input[type="file"] {
      padding: 0.4rem;
    }

    .form-group textarea {
      resize: vertical;
      min-height: 100px;
    }

    .related-places-form {
      margin-top: 1rem;
      padding: 1rem;
      background: #e5f4fd;
      border-radius: 5px;
    }

    .related-place-item {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
      align-items: flex-end;
    }

    .related-place-item input {
      flex: 1;
    }

    .related-place-item button {
      background: #f97316;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .related-place-item button:hover {
      background: #e55e00;
    }

    .form-buttons {
      display: flex;
      gap: 1rem;
    }

    .form-buttons button {
      background: #8BC34A;
      color: white;
      border: none;
      padding: 0.8rem 1.5rem;
      border-radius: 5px;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.3s, transform 0.2s;
    }

    .form-buttons button:hover {
      background: #7cb342;
      transform: translateY(-2px);
    }

    .form-buttons .cancel-btn {
      background: #f97316;
    }

    .form-buttons .cancel-btn:hover {
      background: #e55e00;
    }

    .activities-table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .activities-table th,
    .activities-table td {
      padding: 1rem;
      text-align: left;
      border-bottom: 1px solid #e5f4fd;
    }

    .activities-table th {
      background: #0077b6;
      color: white;
      font-weight: 600;
    }

    .activities-table td img {
      width: 100px;
      height: 60px;
      object-fit: cover;
      border-radius: 5px;
    }

    .activities-table .actions {
      display: flex;
      gap: 0.5rem;
    }

    .activities-table .actions a {
      background: #f97316;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 5px;
      text-decoration: none;
      transition: background 0.3s;
    }

    .activities-table .actions a:hover {
      background: #e55e00;
    }

    .activities-table .actions a.delete-btn {
      background: #d32f2f;
    }

    .activities-table .actions a.delete-btn:hover {
      background: #b71c1c;
    }

    @media screen and (max-width: 768px) {
      nav {
        flex-direction: column;
        align-items: flex-start;
        gap: 1rem;
      }

      .nav-links {
        flex-direction: column;
        align-items: flex-start;
        width: 100%;
      }

      .nav-links a,
      .login-btn button {
        width: 100%;
        text-align: center;
      }

      .dropdown-content {
        position: static;
        width: 100%;
        box-shadow: none;
        transform: none;
        opacity: 1;
      }

      .admin-form,
      .activities-table {
        padding: 1rem;
      }

      .related-place-item {
        flex-direction: column;
      }

      .form-buttons {
        flex-direction: column;
      }

      .activities-table th,
      .activities-table td {
        font-size: 0.8rem;
        padding: 0.8rem;
      }

      .activities-table td img {
        width: 80px;
        height: 50px;
      }
    }
  </style>
</head>
<body>
  <nav>
    <div class="logo">Travel<span>Guide</span></div>
    <div class="nav-links">
      <a href="place.php">Home</a>
      <div class="dropdown">
        <a href="#" class="always-underline">Guides ▼</a>
        <div class="dropdown-content">
          <a href="place.php">Destinations</a>
          <a href="#">Things to Do</a>
          <a href="#">Plan Your Tour</a>
          <a href="#">Places to See</a>
        </div>
      </div>
      <a href="#">Hotels</a>
      <a href="#">Cabs</a>
      <a href="#">About</a>
      <a href="#">Contact Us</a>
      <a href="activityadmin.php">Admin</a>
      <div class="login-btn">
        <button><i class="fas fa-user"></i> Logout</button>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1>Admin Dashboard - Manage Activities</h1>
    <?php if ($message): ?>
      <div class="message <?php echo strpos($message, 'successfully') !== false ? 'success' : 'error'; ?>">
        <?php echo htmlspecialchars($message); ?>
      </div>
    <?php endif; ?>
    <div class="admin-form">
      <h2><?php echo $editing ? 'Edit Activity: ' . htmlspecialchars($editing['title']) : 'Add New Activity'; ?></h2>
      <form method="POST" enctype="multipart/form-data">
        <input type="hidden" name="editing_id" value="<?php echo $editing ? $editing['id'] : ''; ?>">
        <input type="hidden" name="original_key" value="<?php echo $editing ? htmlspecialchars($editing['key']) : ''; ?>">
        <div class="form-group">
          <label for="key">Activity Key (e.g., hiking)</label>
          <input type="text" id="key" name="key" value="<?php echo $editing ? htmlspecialchars($editing['key']) : ''; ?>" <?php echo $editing ? 'disabled' : 'required'; ?> />
        </div>
        <div class="form-group">
          <label for="title">Title</label>
          <input type="text" id="title" name="title" value="<?php echo $editing ? htmlspecialchars($editing['title']) : ''; ?>" required />
        </div>
        <div class="form-group">
          <label for="image">Image (JPG only)</label>
          <input type="file" id="image" name="image" accept=".jpg" <?php echo $editing ? '' : 'required'; ?> />
          <?php if ($editing && $editing['image']): ?>
            <img src="<?php echo htmlspecialchars($editing['image']); ?>" alt="Current Image" style="width: 100px; height: 60px; object-fit: cover; margin-top: 0.5rem;" />
          <?php endif; ?>
        </div>
        <div class="form-group">
          <label for="description">Description</label>
          <textarea id="description" name="description" required><?php echo $editing ? htmlspecialchars($editing['description']) : ''; ?></textarea>
        </div>
        <div class="related-places-form">
          <h3>Related Places</h3>
          <div id="related-places-list">
            <?php if ($editing && $editing['related']): foreach ($editing['related'] as $index => $place): ?>
              <div class="related-place-item">
                <div class="form-group">
                  <label>Related Place Title</label>
                  <input type="text" name="related-title[]" value="<?php echo htmlspecialchars($place['title']); ?>" required />
                </div>
                <div class="form-group">
                  <label>Related Place Image (JPG only)</label>
                  <input type="file" name="related-image[]" accept=".jpg" />
                  <input type="hidden" name="existing-related-image[]" value="<?php echo htmlspecialchars($place['image']); ?>" />
                  <img src="<?php echo htmlspecialchars($place['image']); ?>" alt="Current Image" style="width: 50px; height: 30px; object-fit: cover; margin-top: 0.5rem;" />
                </div>
                <div class="form-group">
                  <label>Related Place Description</label>
                  <input type="text" name="related-description[]" value="<?php echo htmlspecialchars($place['description']); ?>" required />
                </div>
                <div class="form-group">
                  <label>Related Place Map Link (Optional)</label>
                  <input type="text" name="related-map[]" value="<?php echo htmlspecialchars($place['map'] ?? ''); ?>" />
                </div>
                <button type="button" class="remove-related-place">Remove</button>
              </div>
            <?php endforeach; endif; ?>
          </div>
          <button type="button" id="add-related-place">Add Related Place</button>
        </div>
        <div class="form-buttons">
          <button type="submit">Save Activity</button>
          <a href="activityadmin.php" class="cancel-btn">Cancel</a>
        </div>
      </form>
    </div>

    <table class="activities-table">
      <thead>
        <tr>
          <th>Key</th>
          <th>Title</th>
          <th>Image</th>
          <th>Description</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <?php if (empty($activities)): ?>
          <tr>
            <td colspan="5" style="text-align: center;">No activities found. Add a new activity above.</td>
          </tr>
        <?php else: ?>
          <?php foreach ($activities as $act): ?>
            <tr>
              <td><?php echo htmlspecialchars($act['key']); ?></td>
              <td><?php echo htmlspecialchars($act['title']); ?></td>
              <td><img src="<?php echo htmlspecialchars($act['image']); ?>" alt="<?php echo htmlspecialchars($act['title']); ?>" onerror="this.src='img/placeholder.jpg'"></td>
              <td><?php echo htmlspecialchars(substr($act['description'], 0, 50)) . '...'; ?></td>
              <td class="actions">
                <a href="activityadmin.php?edit=<?php echo $act['id']; ?>">Edit</a>
                <a href="activityadmin.php?delete=<?php echo $act['id']; ?>" class="delete-btn" onclick="return confirm('Are you sure you want to delete <?php echo htmlspecialchars($act['title']); ?>?');">Delete</a>
              </td>
            </tr>
          <?php endforeach; ?>
        <?php endif; ?>
      </tbody>
    </table>
  </div>

  <script>
    const relatedPlacesList = document.getElementById('related-places-list');
    const addRelatedPlaceBtn = document.getElementById('add-related-place');

    function addRelatedPlaceInputs() {
      const relatedPlaceItem = document.createElement('div');
      relatedPlaceItem.classList.add('related-place-item');
      relatedPlaceItem.innerHTML = `
        <div class="form-group">
          <label>Related Place Title</label>
          <input type="text" name="related-title[]" required />
        </div>
        <div class="form-group">
          <label>Related Place Image (JPG only)</label>
          <input type="file" name="related-image[]" accept=".jpg" required />
        </div>
        <div class="form-group">
          <label>Related Place Description</label>
          <input type="text" name="related-description[]" required />
        </div>
        <div class="form-group">
          <label>Related Place Map Link (Optional)</label>
          <input type="text" name="related-map[]" />
        </div>
        <button type="button" class="remove-related-place">Remove</button>
      `;
      relatedPlacesList.appendChild(relatedPlaceItem);
      relatedPlaceItem.querySelector('.remove-related-place').addEventListener('click', () => {
        relatedPlaceItem.remove();
      });
    }

    addRelatedPlaceBtn.addEventListener('click', addRelatedPlaceInputs);

    document.querySelectorAll('.remove-related-place').forEach(btn => {
      btn.addEventListener('click', () => {
        btn.closest('.related-place-item').remove();
      });
    });
  </script>
</body>
</html>
<?php
// Flush output buffer
ob_end_flush();
?>